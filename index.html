<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>роорпБро┤рпБроорпИропро╛рой рокроЩрпНроХрпБроЪрпН роЪроирпНродрпИ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --highlight-color: #fef3c7;
            --target-color: #10b981;
            --stop-loss-color: #ef4444;
            --sell-target-color: #ef4444;
            --sell-stop-loss-color: #10b981;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 25px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .upload-zone {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .file-card {
            border: 2px dashed #d1d5db;
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            background-color: #f9fafb;
        }
        
        .file-card:hover {
            border-color: var(--secondary-blue);
            background-color: #f0f7ff;
        }
        
        .file-card.loaded {
            border-color: var(--success-color);
            background-color: #f0fff4;
        }
        
        .file-card.required {
            border-color: var(--danger-color);
            background-color: #fef2f2;
        }
        
        .file-card input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }
        
        .file-label {
            font-size: 12px;
            font-weight: 500;
            color: #4b5563;
            margin-top: 5px;
            display: block;
        }
        
        .required-badge {
            background-color: var(--danger-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .stat-box {
            background: white;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-bottom: 5px solid #ddd;
            transition: transform 0.2s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
        }
        
        .stock-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 6px solid #ddd;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .stock-card.highlight {
            background-color: var(--highlight-color);
            border-left: 6px solid #f59e0b;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }
        
        .stock-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .whatsapp-icon {
            color: #25D366;
            font-size: 22px;
            text-decoration: none;
            transition: transform 0.2s;
        }
        
        .whatsapp-icon:hover {
            transform: scale(1.2);
        }
        
        .badge-custom {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            color: white;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .percentage-change {
            font-weight: 700;
        }
        
        .positive {
            color: var(--success-color);
        }
        
        .negative {
            color: var(--danger-color);
        }
        
        .instructions {
            background-color: #f0f9ff;
            border-left: 5px solid var(--info-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .debug-info {
            background-color: #fef3c7;
            border-left: 5px solid #f59e0b;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 10px;
            display: none;
        }
        
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            border-top: 1px solid #e5e7eb;
        }
        
        .column-preview {
            font-size: 11px;
            color: #6b7280;
            margin-top: 5px;
            max-height: 60px;
            overflow-y: auto;
            text-align: left;
            padding: 5px;
            background: #f9fafb;
            border-radius: 3px;
        }
        
        .data-info {
            background-color: #ecfdf5;
            border-left: 5px solid var(--success-color);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .series-filter {
            background-color: #e0f2fe;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .series-badge {
            background-color: #3b82f6;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .reason-highlight {
            background-color: var(--highlight-color);
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            border-left: 4px solid #f59e0b;
        }
        
        .top-stocks {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #f59e0b;
        }
        
        .top-stock-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .reason-count-badge {
            background-color: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .target-badge {
            background-color: var(--target-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .stop-loss-badge {
            background-color: var(--stop-loss-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .sell-target-badge {
            background-color: var(--sell-target-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .sell-stop-loss-badge {
            background-color: var(--sell-stop-loss-color);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .price-cell {
            font-weight: 600;
            font-size: 13px;
        }
        
        .whatsapp-share-all {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .whatsapp-share-all:hover {
            background-color: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }
        
        .news-badge {
            background-color: #8b5cf6;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        /* рокрпБродро┐роп ро╕рпНроЯрпИро▓рпНроХро│рпН */
        .selected-count-badge {
            background-color: #8b5cf6;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .print-btn {
            background-color: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .print-btn:hover {
            background-color: #4b5563;
            transform: translateY(-2px);
        }
        
        .select-all-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .top-stock-checkbox {
            margin-right: 15px;
            transform: scale(1.1);
        }
        
        /* рокро┐ро░ро┐рогрпНроЯрпН ро╕рпНроЯрпИро▓рпНроХро│рпН */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #printable-area, #printable-area * {
                visibility: visible;
            }
            
            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                background-color: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            
            th {
                background-color: #f2f2f2;
            }
        }
    </style>
</head>
<body>

<div class="header-section">
    <h2><i class="fas fa-chart-line"></i> роорпБро┤рпБроорпИропро╛рой рокроЩрпНроХрпБроЪрпН роЪроирпНродрпИ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ</h2>
    <p class="mb-0">7 CSV роХрпЛрокрпНрокрпБроХро│рпИ роТрокрпНрокро┐роЯрпНроЯрпБ рокроЩрпНроХрпБ рокро░ро┐роирпНродрпБро░рпИроХро│рпН (EQ рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН)</p>
</div>

<div class="container">
    <div class="instructions">
        <h5><i class="fas fa-info-circle text-info"></i> CSV роирпЖроЯрпБро╡ро░ро┐роЪрпИ рокрпЖропро░рпНроХро│рпИ роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН:</h5>
        <p><strong>StocksTraded.csv</strong> роХрпЛрокрпНрокрпБ роорпБроХрпНроХро┐роп роХрпЛрокрпНрокро╛роХ рокропройрпНрокроЯрпБродрпНродрокрпНрокроЯрпБроорпН. роЗродро┐ро▓рпН рокро┐ройрпНро╡ро░рпБроорпН роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН роЗро░рпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН:</p>
        <ul>
            <li><strong>рокроЩрпНроХрпБ рокрпЖропро░рпН/роЪро┐ройрпНройроорпН</strong> (роО.роХро╛: SYMBOL, Symbol, ticker)</li>
            <li><strong>ро╡ро┐ро▓рпИ</strong> (роО.роХро╛: LTP, Last Price, close, price) - <span class="text-success">роорпБроХрпНроХро┐ропроорпН</span></li>
            <li><strong>рооро╛ро▒рпНро▒роорпН роЪродро╡рпАродроорпН</strong> (роО.роХро╛: %CHNG, PCT_CHG, %Change) - <span class="text-success">роорпБроХрпНроХро┐ропроорпН</span></li>
            <li><strong>Series</strong> (роО.роХро╛: EQ, BE, BL, роЗродро┐ро▓рпН <span class="series-badge">EQ</span> рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЪрпЖропрпНропрокрпНрокроЯрпБроорпН)</li>
        </ul>
        <div class="series-filter">
            <strong><i class="fas fa-filter"></i> роорпБроХрпНроХро┐роп роЕроорпНроЪроЩрпНроХро│рпН:</strong> 
            <span class="series-badge">EQ рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН</span> | 
            <span class="target-badge">BUY - роЯро╛ро░рпНроХрпЖроЯрпН/ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН</span> | 
            <span class="sell-target-badge">SELL - роЯро╛ро░рпНроХрпЖроЯрпН/ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН</span> |
            <span class="badge-custom" style="background-color:#f59e0b">рооро╛ро▒рпНро▒роорпН родрпКроХрпИ роХрогроХрпНроХро┐роЯрокрпНрокроЯрпБроорпН</span>
            <span class="badge-custom" style="background-color:#8b5cf6">ро░рпАрокро┐ро░ро╖рпН роЕро┤ро┐ропро╛родрпБ</span>
        </div>
    </div>
    
    <div class="upload-zone mb-5">
        <h4 class="mb-4 text-primary"><i class="fas fa-upload"></i> 1. CSV роХрпЛрокрпНрокрпБроХро│рпИ рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН</h4>
        <div class="file-grid" id="fileGrid"></div>
        
        <div class="row">
            <div class="col-md-4">
                <button class="btn btn-info w-100 py-3 mb-3" onclick="checkColumns()" id="checkColumnsBtn">
                    <i class="fas fa-search"></i> CSV родро░ро╡рпИ роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-warning w-100 py-3 mb-3" onclick="loadFromLocalStorage()" id="loadBtn">
                    <i class="fas fa-history"></i> роорпБроирпНродрпИроп родро░ро╡рпИ роПро▒рпНро▒рпБ
                </button>
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary btn-lg w-100 py-3 fw-bold" onclick="analyzeEverything()" id="analyzeBtn">
                    <i class="fas fa-sync-alt"></i> рокроХрпБрокрпНрокро╛ропрпНро╡рпИродрпН родрпКроЯроЩрпНроХрпБ
                </button>
            </div>
        </div>
        
        <div id="uploadStatus" class="mt-3 text-center"></div>
        <div id="columnInfo" class="debug-info"></div>
        <div id="dataPreview" class="debug-info" style="background-color:#e0f2fe; border-color:#0ea5e9;"></div>
        <div id="eqFilterInfo" class="debug-info" style="background-color:#d1fae5; border-color:#10b981;"></div>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="data-info">
            <h5><i class="fas fa-database text-success"></i> родро░ро╡рпБ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роорпБроЯро┐ро╡рпБроХро│рпН</h5>
            <div id="dataSummary">
                <p><strong>StocksTraded.csv:</strong> <span id="totalRows">0</span> рокроЩрпНроХрпБроХро│рпН (роорпКродрпНродроорпН) | 
                <strong><span class="series-badge">EQ</span> рокроЩрпНроХрпБроХро│рпН:</strong> <span id="eqRows">0</span> | 
                <strong>роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН (1+ роХро╛ро░рогроЩрпНроХро│рпН):</strong> <span id="highlightedRows">0</span></p>
            </div>
        </div>
        
        <!-- роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН рокро┐ро░ро┐ро╡рпБ -->
        <div id="topStocksSection" style="display:none;">
            <div class="top-stocks">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-star text-warning"></i> роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН (рокро▓ роХро╛ро░рогроЩрпНроХро│рпН + роЯро╛ро░рпНроХрпЖроЯрпН/ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН)</h5>
                    <div>
                        <span class="selected-count-badge me-2" id="selectedCountBadge" style="display:none;">0 родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ</span>
                        <button class="btn print-btn me-2 no-print" onclick="printSelectedStocks()">
                            <i class="fas fa-print"></i> родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯро╡рпИ рокро┐ро░ро┐рогрпНроЯрпН
                        </button>
                        <button class="btn whatsapp-share-all no-print" onclick="shareAllTopStocks()">
                            <i class="fab fa-whatsapp"></i> WhatsApp роЗро▓рпН рокроХро┐ро░рпН
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info no-print">
                    <div class="form-check">
                        <input class="form-check-input select-all-checkbox" type="checkbox" id="selectAllTopStocks" onchange="toggleSelectAllTopStocks()">
                        <label class="form-check-label fw-bold" for="selectAllTopStocks">
                            <i class="fas fa-check-square"></i> роЕройрпИродрпНродрпБ роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпИропрпБроорпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХ
                        </label>
                    </div>
                    <hr class="my-2">
                    <i class="fas fa-info-circle"></i> <strong>роХрпБро▒ро┐рокрпНрокрпБ:</strong> 
                    тАв BUY: роЯро╛ро░рпНроХрпЖроЯрпН = ро╡ро┐ро▓рпИ + (рооро╛ро▒рпНро▒роорпН ├Ч 1.5) | ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН = ро╡ро┐ро▓рпИ - (рооро╛ро▒рпНро▒роорпН ├Ч 1.0)<br>
                    тАв SELL: роЯро╛ро░рпНроХрпЖроЯрпН = ро╡ро┐ро▓рпИ - (рооро╛ро▒рпНро▒роорпН ├Ч 1.0) | ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН = ро╡ро┐ро▓рпИ + (рооро╛ро▒рпНро▒роорпН ├Ч 1.5)
                </div>
                <div id="topStocksList"></div>
            </div>
        </div>
        
        <h3 class="mb-4"><i class="fas fa-tachometer-alt"></i> рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роорпБроЯро┐ро╡рпБроХро│рпН (<span class="series-badge">EQ</span> рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН)</h3>
        
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-box">
                    <h6 class="text-muted">роорпКродрпНрод EQ рокроЩрпНроХрпБроХро│рпН</h6>
                    <h3 id="totalS" class="text-dark">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box" style="border-color:var(--success-color)">
                    <h6 class="text-muted">ро╡ро╛роЩрпНроХ (BUY)</h6>
                    <h3 id="buyS" class="text-success">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box" style="border-color:var(--danger-color)">
                    <h6 class="text-muted">ро╡ро┐ро▒рпНроХ (SELL)</h6>
                    <h3 id="sellS" class="text-danger">0</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box" style="border-color:var(--warning-color)">
                    <h6 class="text-muted">роХро╛родрпНродро┐ро░рпБроХрпНроХ (HOLD)</h6>
                    <h3 id="holdS" class="text-warning">0</h3>
                </div>
            </div>
        </div>

        <div class="filter-section no-print">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="search" class="form-control" placeholder="рокроЩрпНроХрпБ рокрпЖропро░рпИ родрпЗроЯрпБроХ...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select id="sigFilter" class="form-select">
                        <option value="ALL">роЕройрпИродрпНродрпБ роЪро┐роХрпНройро▓рпНроХро│рпН</option>
                        <option value="BUY">BUY роороЯрпНроЯрпБроорпН</option>
                        <option value="SELL">SELL роороЯрпНроЯрпБроорпН</option>
                        <option value="HOLD">HOLD роороЯрпНроЯрпБроорпН</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="pctFilter" class="form-select">
                        <option value="ALL">роЕройрпИродрпНродрпБ %</option>
                        <option value="POSITIVE">роирпЗро░рпНрооро▒рпИ %</option>
                        <option value="NEGATIVE">роОродро┐ро░рпНрооро▒рпИ %</option>
                        <option value="HIGH">+2% роХрпНроХрпБ роорпЗро▓рпН</option>
                        <option value="LOW">-2% роХрпНроХрпБ роХрпАро┤рпН</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="reasonFilter" class="form-select">
                        <option value="ALL">роЕройрпИродрпНродрпБ рокроЩрпНроХрпБроХро│рпН</option>
                        <option value="MULTIPLE">1+ роХро╛ро░рогроЩрпНроХро│рпН</option>
                        <option value="HIGHLIGHT">роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="sortFilter" class="form-select">
                        <option value="default">роЗропро▓рпНрокрпБ ро╡ро░ро┐роЪрпИ</option>
                        <option value="pct_high">роЕродро┐роХ роЪродро╡рпАрод рооро╛ро▒рпНро▒роорпН (тЖС)</option>
                        <option value="pct_low">роХрпБро▒рпИроирпНрод роЪродро╡рпАрод рооро╛ро▒рпНро▒роорпН (тЖУ)</option>
                        <option value="name">рокроЩрпНроХрпБ рокрпЖропро░рпН (A-Z)</option>
                        <option value="reasons">рокро▓ роХро╛ро░рогроЩрпНроХро│рпН (тЖУ)</option>
                        <option value="target_high">роЕродро┐роХ роЯро╛ро░рпНроХрпЖроЯрпН (тЖУ)</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-3 mt-2">
                <div class="col-md-2">
                    <button class="btn btn-dark w-100" onclick="exportData()">
                        <i class="fas fa-download"></i> роПро▒рпНро▒рпБроХ
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-warning w-100" onclick="showHighlightedStocks()">
                        <i class="fas fa-star"></i> роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" onclick="showAllStocks()">
                        <i class="fas fa-list"></i> роЕройрпИродрпНродрпБроорпН
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-info w-100" onclick="showChangeCalculationInfo()">
                        <i class="fas fa-calculator"></i> роХрогроХрпНроХрпАроЯрпБ
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="saveToLocalStorage()">
                        <i class="fas fa-save"></i> роЪрпЗрооро┐
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn print-btn w-100" onclick="printCurrentPage()">
                        <i class="fas fa-print"></i> рокро┐ро░ро┐рогрпНроЯрпН
                    </button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover" id="resultsTable">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>рокроЩрпНроХрпБ рокрпЖропро░рпН</th>
                        <th>ро╡ро┐ро▓рпИ (тВ╣)</th>
                        <th>рооро╛ро▒рпНро▒роорпН родрпКроХрпИ*</th>
                        <th>рооро╛ро▒рпНро▒роорпН %</th>
                        <th>Series</th>
                        <th>роЪро┐роХрпНройро▓рпН</th>
                        <th>роХро╛ро░рогроорпН</th>
                        <th>роЯро╛ро░рпНроХрпЖроЯрпН</th>
                        <th>ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН</th>
                        <th class="no-print">рокроХро┐ро░рпН</th>
                    </tr>
                </thead>
                <tbody id="results">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
            <p class="text-muted small mt-2">*рооро╛ро▒рпНро▒роорпН родрпКроХрпИ = (родро▒рпНрокрпЛродрпИроп ро╡ро┐ро▓рпИ ├Ч рооро╛ро▒рпНро▒роорпН %) ├╖ 100</p>
        </div>
        
        <div id="noResults" style="display:none;">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle fa-lg"></i>
                <h5 class="mt-2">родрпЗроЯро▓рпБроХрпНроХрпБ рокрпКро░рпБроирпНродрпБроорпН рокроЩрпНроХрпБроХро│рпН роЗро▓рпНро▓рпИ</h5>
                <p>родрпЗроЯро▓рпН роЪрпКро▓рпНро▓рпИ рооро╛ро▒рпНро▒ро┐ роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН</p>
            </div>
        </div>
        
        <nav aria-label="Page navigation" class="no-print">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
        
        <div class="footer no-print">
            <p>рокроЩрпНроХрпБроЪрпН роЪроирпНродрпИ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЕроорпИрокрпНрокрпБ &copy; 2023 | StocksTraded.csv (EQ рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН) роЕроЯро┐рокрпНрокроЯрпИропро┐ро▓рпН</p>
            <p class="small">рокро░ро┐роирпНродрпБро░рпИроХро│рпН родроХро╡ро▓рпН роирпЛроХрпНроХродрпНродро┐ро▒рпНроХро╛роХ роороЯрпНроЯрпБроорпЗ. роорпБродро▓рпАроЯрпНроЯрпБ роорпБроЯро┐ро╡рпБроХро│рпБроХрпНроХрпБ роорпБройрпН роЙроЩрпНроХро│рпН роЖро░ро╛ропрпНроЪрпНроЪро┐ роЪрпЖропрпНропро╡рпБроорпН</p>
        </div>
    </div>
</div>

<!-- рокро┐ро░ро┐рогрпНроЯрпН рокроХрпБродро┐ (рооро▒рпИроирпНродрпБ роЗро░рпБроХрпНроХрпБроорпН) -->
<div id="printable-area" style="display: none;">
    <h2 style="text-align: center; margin-bottom: 20px;">ЁЯУК рокроЩрпНроХрпБроЪрпН роЪроирпНродрпИ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роорпБроЯро┐ро╡рпБроХро│рпН</h2>
    
    <div style="margin-bottom: 15px;">
        <p><strong>родрпЗродро┐:</strong> <span id="print-date"></span></p>
        <p><strong>роорпКродрпНрод EQ рокроЩрпНроХрпБроХро│рпН:</strong> <span id="print-total"></span> | 
           <strong>BUY:</strong> <span id="print-buy"></span> | 
           <strong>SELL:</strong> <span id="print-sell"></span> | 
           <strong>HOLD:</strong> <span id="print-hold"></span></p>
    </div>
    
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">#</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">рокроЩрпНроХрпБ рокрпЖропро░рпН</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ро╡ро┐ро▓рпИ (тВ╣)</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">рооро╛ро▒рпНро▒роорпН %</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Series</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">роЪро┐роХрпНройро▓рпН</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">роХро╛ро░рогроорпН</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">роЯро╛ро░рпНроХрпЖроЯрпН</th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН</th>
            </tr>
        </thead>
        <tbody id="print-body">
            <!-- рокро┐ро░ро┐рогрпНроЯрпН родро░ро╡рпБ роЗроЩрпНроХрпЗ роиро┐ро░рокрпНрокрокрпНрокроЯрпБроорпН -->
        </tbody>
    </table>
    
    <div style="margin-top: 20px; font-size: 12px; color: #666;">
        <p>*рооро╛ро▒рпНро▒роорпН родрпКроХрпИ = (родро▒рпНрокрпЛродрпИроп ро╡ро┐ро▓рпИ ├Ч рооро╛ро▒рпНро▒роорпН %) ├╖ 100</p>
        <p>рокро░ро┐роирпНродрпБро░рпИроХро│рпН родроХро╡ро▓рпН роирпЛроХрпНроХродрпНродро┐ро▒рпНроХро╛роХ роороЯрпНроЯрпБроорпЗ. роорпБродро▓рпАроЯрпНроЯрпБ роорпБроЯро┐ро╡рпБроХро│рпБроХрпНроХрпБ роорпБройрпН роЙроЩрпНроХро│рпН роЖро░ро╛ропрпНроЪрпНроЪро┐ роЪрпЖропрпНропро╡рпБроорпН</p>
    </div>
</div>

<script>
    // CSV роХрпЛрокрпНрокрпБ рокрпЖропро░рпНроХро│рпН
    const fileNames = [
        "52WeekHigh", "52WeekLow", "Upper Band", "Lower Band", 
        "T20-gainers", "T20-loosers", "StocksTraded"
    ];
    
    // родро░ро╡рпБ роЪрпЗрооро┐рокрпНрокрпБ
    let storage = {};
    let finalArray = [];
    let originalOrder = [];
    let currentPage = 1;
    const itemsPerPage = 50;
    
    // роирпЖроЯрпБро╡ро░ро┐роЪрпИ роорпЗрокрпНрокро┐роЩрпН
    let columnMapping = {
        "StocksTraded": {
            symbol: null,
            price: null,
            change: null,
            changePct: null,
            series: null
        }
    };
    
    // роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН
    let highlightedStocks = [];
    let selectedTopStocks = new Set();
    
    // ро▓рпЛроХрпНроХро▓рпН ро╕рпНроЯрпЛро░рпЗроЬрпН роХрпА
    const STORAGE_KEY = 'stockMarketAnalysisData';
    
    // рокродро┐ро╡рпЗро▒рпНро▒роорпН UI роЙро░рпБро╡ро╛роХрпНроХроорпН
    const grid = document.getElementById('fileGrid');
    fileNames.forEach((name, i) => {
        const isRequired = name === "StocksTraded";
        grid.innerHTML += `
            <div class="file-card ${isRequired ? 'required' : ''}" id="box-${i}">
                <i class="fas fa-file-csv fa-2x mb-2 ${isRequired ? 'text-danger' : 'text-secondary'}"></i>
                <div class="file-label">${name}</div>
                ${isRequired ? '<div class="required-badge">роЕро╡роЪро┐ропроорпН</div>' : ''}
                <div id="preview-${i}" class="column-preview"></div>
                <input type="file" accept=".csv" onchange="readCSV(event, '${name}', ${i})">
            </div>
        `;
    });
    
    // ро░рпАрокро┐ро░ро╖рпН роЕро┤ро┐ропро╛рооро▓рпН роЗро░рпБрокрпНрокродро▒рпНроХрпБ ро▓рпЛроХрпНроХро▓рпН ро╕рпНроЯрпЛро░рпЗроЬро┐ро▓рпН роЗро░рпБроирпНродрпБ ро▓рпЛроЯрпН роЪрпЖропрпНропрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function loadFromLocalStorage() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) {
            alert("роорпБройрпНройро░рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯ родро░ро╡рпБ роЗро▓рпНро▓рпИ.");
            return;
        }
        
        try {
            const parsedData = JSON.parse(savedData);
            storage = parsedData.storage || {};
            finalArray = parsedData.finalArray || [];
            originalOrder = parsedData.originalOrder || [];
            highlightedStocks = parsedData.highlightedStocks || [];
            columnMapping = parsedData.columnMapping || {
                "StocksTraded": {
                    symbol: null,
                    price: null,
                    change: null,
                    changePct: null,
                    series: null
                }
            };
            
            // рокродро┐ро╡рпЗро▒рпНро▒рокрпНрокроЯрпНроЯ роХрпЛрокрпНрокрпБроХро│ро┐ройрпН UI роРрокрпН рокрпБродрпБрокрпНрокро┐роХрпНроХро╡рпБроорпН
            fileNames.forEach((name, i) => {
                if (storage[name]) {
                    const previewDiv = document.getElementById(`preview-${i}`);
                    const boxDiv = document.getElementById(`box-${i}`);
                    
                    if (previewDiv && boxDiv) {
                        const columns = Object.keys(storage[name][0] || {}).slice(0, 6);
                        previewDiv.innerHTML = `<strong>роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН:</strong> ${columns.join(', ')}...<br>
                                               <strong>роорпКродрпНрод ро╡ро░ро┐роЪрпИроХро│рпН:</strong> ${storage[name].length}`;
                        boxDiv.classList.add('loaded');
                        boxDiv.querySelector('i').className = 'fas fa-check-circle fa-2x text-success mb-2';
                    }
                }
            });
            
            // роЯро╛ро╖рпНрокрпЛро░рпНроЯрпИ роХро╛рогрпНрокро┐роХрпНроХро╡рпБроорпН
            if (finalArray.length > 0) {
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('totalRows').textContent = parsedData.totalRows || 0;
                document.getElementById('eqRows').textContent = parsedData.eqRows || 0;
                document.getElementById('highlightedRows').textContent = highlightedStocks.length;
                
                if (highlightedStocks.length > 0) {
                    showHighlightedStocks();
                }
                
                render();
                
                document.getElementById('uploadStatus').innerHTML = 
                    `<div class="alert alert-success d-inline-block"><i class="fas fa-check"></i> роорпБройрпНройро░рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯ родро░ро╡рпБ роПро▒рпНро▒рокрпНрокроЯрпНроЯродрпБ (${finalArray.length} рокроЩрпНроХрпБроХро│рпН)</div>`;
                
                setTimeout(() => {
                    document.getElementById('uploadStatus').innerHTML = '';
                }, 3000);
            }
        } catch (error) {
            console.error("родро░ро╡рпБ роПро▒рпНро▒роорпН родрпЛро▓рпНро╡ро┐ропрпБро▒рпНро▒родрпБ:", error);
            alert("родро░ро╡рпБ роПро▒рпНро▒роорпН родрпЛро▓рпНро╡ро┐ропрпБро▒рпНро▒родрпБ. роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН.");
        }
    }
    
    // ро▓рпЛроХрпНроХро▓рпН ро╕рпНроЯрпЛро░рпЗроЬро┐ро▓рпН роЪрпЗрооро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function saveToLocalStorage() {
        if (finalArray.length === 0) {
            alert("роорпБродро▓ро┐ро▓рпН рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН.");
            return;
        }
        
        const saveData = {
            storage: storage,
            finalArray: finalArray,
            originalOrder: originalOrder,
            highlightedStocks: highlightedStocks,
            columnMapping: columnMapping,
            totalRows: document.getElementById('totalRows').textContent,
            eqRows: document.getElementById('eqRows').textContent,
            saveTimestamp: new Date().toISOString()
        };
        
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
            alert(`родро░ро╡рпБ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯродрпБ! (${finalArray.length} рокроЩрпНроХрпБроХро│рпН)\n\nро░рпАрокро┐ро░ро╖рпН роЪрпЖропрпНродро╛ро▓рпБроорпН родро░ро╡рпБ роЕро┤ро┐ропро╛родрпБ.`);
        } catch (error) {
            console.error("роЪрпЗрооро┐рокрпНрокрпБ родрпЛро▓рпНро╡ро┐ропрпБро▒рпНро▒родрпБ:", error);
            alert("роЪрпЗрооро┐рокрпНрокрпБ родрпЛро▓рпНро╡ро┐ропрпБро▒рпНро▒родрпБ. LocalStorage роЗроЯроорпН роЗро▓рпНро▓рпИ.");
        }
    }
    
    // CSV роХрпЛрокрпНрокрпИ рокроЯро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function readCSV(event, type, idx) {
        const file = event.target.files[0];
        if (!file) return;
        
        document.getElementById('uploadStatus').innerHTML = 
            `<div class="alert alert-info d-inline-block"><i class="fas fa-spinner fa-spin"></i> "${type}" роХрпЛрокрпНрокрпБ рокроЯро┐роХрпНроХрокрпНрокроЯрпБроХро┐ро▒родрпБ...</div>`;
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(res) {
                const processedData = res.data.map(row => {
                    const newRow = {};
                    for (const key in row) {
                        if (row.hasOwnProperty(key)) {
                            const newKey = key.toLowerCase().trim();
                            newRow[newKey] = row[key];
                        }
                    }
                    return newRow;
                }).filter(row => {
                    return Object.keys(row).length > 0 && 
                           !Object.values(row).every(val => val === '' || val === null || val === undefined);
                });
                
                storage[type] = processedData;
                
                if (processedData.length > 0) {
                    const previewDiv = document.getElementById(`preview-${idx}`);
                    const columns = Object.keys(processedData[0]).slice(0, 6);
                    previewDiv.innerHTML = `<strong>роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН:</strong> ${columns.join(', ')}...<br>
                                           <strong>роорпКродрпНрод ро╡ро░ро┐роЪрпИроХро│рпН:</strong> ${processedData.length}`;
                }
                
                document.getElementById(`box-${idx}`).classList.add('loaded');
                document.getElementById(`box-${idx}`).querySelector('i').className = 'fas fa-check-circle fa-2x text-success mb-2';
                
                document.getElementById('uploadStatus').innerHTML = 
                    `<div class="alert alert-success d-inline-block"><i class="fas fa-check"></i> "${type}" роХрпЛрокрпНрокрпБ рокродро┐ро╡рпЗро▒рпНро▒рокрпНрокроЯрпНроЯродрпБ (${processedData.length} рокродро┐ро╡рпБроХро│рпН)</div>`;
                
                setTimeout(() => {
                    document.getElementById('uploadStatus').innerHTML = '';
                }, 3000);
                
                if (type === "StocksTraded" && processedData.length > 0) {
                    autoDetectColumns(processedData[0], type);
                    showDataPreview(processedData);
                    showEQFilterInfo(processedData);
                }
            },
            error: function(err) {
                alert(`${type} роХрпЛрокрпНрокрпИ рокроЯро┐роХрпНроХ роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ: ${err.message}`);
                document.getElementById('uploadStatus').innerHTML = 
                    `<div class="alert alert-danger d-inline-block"><i class="fas fa-exclamation-triangle"></i> "${type}" роХрпЛрокрпНрокрпБ рокродро┐ро╡рпЗро▒рпНро▒роорпН родрпЛро▓рпНро╡ро┐ропрпБро▒рпНро▒родрпБ</div>`;
            }
        });
    }
    
    // CSV родро░ро╡рпБ рооро╛родро┐ро░ро┐ропрпИ роХро╛рогрпНрокро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function showDataPreview(data) {
        const previewDiv = document.getElementById('dataPreview');
        if (data.length > 0) {
            previewDiv.innerHTML = `
                <strong><i class="fas fa-table text-info"></i> StocksTraded.csv родро░ро╡рпБ рооро╛родро┐ро░ро┐ (роорпБродро▓рпН 3 ро╡ро░ро┐роЪрпИроХро│рпН):</strong><br>
                <div style="max-height: 200px; overflow-y: auto; background: white; padding: 10px; border-radius: 5px; margin-top: 5px;">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                ${Object.keys(data[0]).slice(0, 6).map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 3).map(row => `
                                <tr>
                                    ${Object.keys(row).slice(0, 6).map(col => `<td>${row[col] || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <p class="mb-0 mt-2"><strong>роорпКродрпНрод ро╡ро░ро┐роЪрпИроХро│рпН:</strong> ${data.length} | <strong>роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН:</strong> ${Object.keys(data[0]).length}</p>
            `;
            previewDiv.style.display = 'block';
        }
    }
    
    // EQ ро╡роЯро┐роХроЯрпНроЯро▓рпН родроХро╡ро▓рпИ роХро╛рогрпНрокро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function showEQFilterInfo(data) {
        const eqInfoDiv = document.getElementById('eqFilterInfo');
        
        if (data.length > 0) {
            const seriesColumn = findSeriesColumn(data[0]);
            
            if (seriesColumn) {
                let eqCount = 0;
                let nonEqCount = 0;
                let seriesTypes = {};
                
                data.forEach(row => {
                    const seriesValue = row[seriesColumn] ? String(row[seriesColumn]).trim().toUpperCase() : '';
                    if (seriesTypes[seriesValue]) {
                        seriesTypes[seriesValue]++;
                    } else {
                        seriesTypes[seriesValue] = 1;
                    }
                    
                    if (seriesValue === 'EQ') {
                        eqCount++;
                    } else {
                        nonEqCount++;
                    }
                });
                
                const seriesList = Object.entries(seriesTypes)
                    .map(([type, count]) => `${type}: ${count}`)
                    .join(', ');
                
                eqInfoDiv.innerHTML = `
                    <strong><i class="fas fa-filter text-success"></i> Series ро╡роЯро┐роХроЯрпНроЯро▓рпН родроХро╡ро▓рпН:</strong><br>
                    <strong>Series роирпЖроЯрпБро╡ро░ро┐роЪрпИ:</strong> <code>${seriesColumn}</code><br>
                    <strong>EQ рокроЩрпНроХрпБроХро│рпН:</strong> ${eqCount} | <strong>рооро▒рпНро▒ Series:</strong> ${nonEqCount}<br>
                    <strong>роЕройрпИродрпНродрпБ Series ро╡роХрпИроХро│рпН:</strong> ${seriesList}<br>
                    <span class="text-success"><i class="fas fa-info-circle"></i> <strong>EQ рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЪрпЖропрпНропрокрпНрокроЯрпБроорпН.</strong></span>
                `;
                eqInfoDiv.style.display = 'block';
            } else {
                eqInfoDiv.innerHTML = `
                    <strong><i class="fas fa-exclamation-triangle text-warning"></i> Series роирпЖроЯрпБро╡ро░ро┐роЪрпИ роХрогрпНроЯро▒ро┐ропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ:</strong><br>
                    CSV роХрпЛрокрпНрокро┐ро▓рпН "series", "SERIES", "Series" рокрпЛройрпНро▒ роирпЖроЯрпБро╡ро░ро┐роЪрпИ рокрпЖропро░рпН роЗро░рпБроХрпНроХ ро╡рпЗрогрпНроЯрпБроорпН.
                `;
                eqInfoDiv.style.display = 'block';
            }
        }
    }
    
    // Series роирпЖроЯрпБро╡ро░ро┐роЪрпИропрпИроХрпН роХрогрпНроЯро▒ро┐родро▓рпН
    function findSeriesColumn(row) {
        const seriesKeys = ['series', 'series', 'ser', 'type', 'segment'];
        for (let key of seriesKeys) {
            const found = Object.keys(row).find(k => {
                const kNorm = k.trim().toLowerCase().replace(/[^a-z]/g, '');
                const keyNorm = key.trim().toLowerCase().replace(/[^a-z]/g, '');
                return kNorm === keyNorm;
            });
            if (found) return found;
        }
        return null;
    }
    
    // CSV родро░ро╡ро┐ро▓ро┐ро░рпБроирпНродрпБ роородро┐рокрпНрокрпИ рокрпЖро▒рпБро╡родро▒рпНроХро╛рой роЪрпЖропро▓рпНрокро╛роЯрпБ
    function getValue(obj, keys) {
        if (!obj) return null;
        
        for (let key of keys) {
            const found = Object.keys(obj).find(k => {
                const kNorm = k.trim().toLowerCase().replace(/[^a-z0-9%]/g, '');
                const keyNorm = key.trim().toLowerCase().replace(/[^a-z0-9%]/g, '');
                return kNorm === keyNorm;
            });
            if (found && obj[found] !== undefined && obj[found] !== "") {
                return obj[found];
            }
        }
        return null;
    }
    
    // роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпИ родро╛ройро╛роХ роХрогрпНроЯро▒ро┐родро▓рпН
    function autoDetectColumns(row, type) {
        if (!row) return;
        
        const columnNames = Object.keys(row);
        
        const symbolKeys = ['symbol', 'ticker', 'scrip', 'stock', 'company', 'name', 'security'];
        columnMapping[type].symbol = findMatchingColumn(columnNames, symbolKeys);
        
        const priceKeys = ['ltp', 'last price', 'close', 'price', 'last', 'cmp', 'current', 'last traded price'];
        columnMapping[type].price = findMatchingColumn(columnNames, priceKeys);
        
        const changeKeys = ['change', 'chg', 'netchng', 'change_amt', 'change_value', 'net change', 'changeinprice', 'chng'];
        columnMapping[type].change = findMatchingColumn(columnNames, changeKeys);
        
        const changePctKeys = ['%chng', 'pct_chg', '%change', 'chg_pct', 'change_pct', 'pctchg', '% chng', '%change', 'percent change', 'pct_change', '%chg'];
        columnMapping[type].changePct = findMatchingColumn(columnNames, changePctKeys);
        
        const seriesKeys = ['series', 'series', 'ser', 'type', 'segment'];
        columnMapping[type].series = findMatchingColumn(columnNames, seriesKeys);
    }
    
    // рокрпКро░рпБроирпНродрпБроорпН роирпЖроЯрпБро╡ро░ро┐роЪрпИропрпИ роХрогрпНроЯро▒ро┐родро▓рпН
    function findMatchingColumn(availableColumns, possibleNames) {
        for (let name of possibleNames) {
            const found = availableColumns.find(col => {
                const colNorm = col.trim().toLowerCase().replace(/[^a-z0-9%]/g, '');
                const nameNorm = name.trim().toLowerCase().replace(/[^a-z0-9%]/g, '');
                return colNorm === nameNorm;
            });
            if (found) return found;
        }
        return null;
    }
    
    // роирпЖроЯрпБро╡ро░ро┐роЪрпИ родроХро╡ро▓рпИ роХро╛рогрпНрокро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function showColumnInfo() {
        const infoDiv = document.getElementById('columnInfo');
        const mapping = columnMapping["StocksTraded"];
        
        if (mapping.symbol && mapping.price && mapping.series) {
            infoDiv.innerHTML = `
                <strong><i class="fas fa-check-circle text-success"></i> роорпБроХрпНроХро┐роп роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН роХрогрпНроЯро▒ро┐ропрокрпНрокроЯрпНроЯрой:</strong><br>
                тАв рокроЩрпНроХрпБ рокрпЖропро░рпН: <code>${mapping.symbol}</code><br>
                тАв ро╡ро┐ро▓рпИ: <code>${mapping.price}</code><br>
                тАв Series: <code>${mapping.series}</code> <span class="series-badge">EQ роороЯрпНроЯрпБроорпН</span><br>
                тАв рооро╛ро▒рпНро▒роорпН %: ${mapping.changePct ? `<code>${mapping.changePct}</code>` : '<span class="text-danger">роХро╛рогро╡ро┐ро▓рпНро▓рпИ</span>'}<br>
                тАв рооро╛ро▒рпНро▒роорпН родрпКроХрпИ: ${mapping.change ? `<code>${mapping.change}</code> (CSV роЗро▓рпН роЗро░рпБроирпНродрпБ)` : '<span class="text-warning">роХро╛рогро╡ро┐ро▓рпНро▓рпИ - роХрогроХрпНроХро┐роЯрокрпНрокроЯрпБроорпН</span>'}
            `;
            infoDiv.style.display = 'block';
        } else {
            infoDiv.innerHTML = `
                <strong><i class="fas fa-exclamation-triangle text-warning"></i> роорпБроХрпНроХро┐роп роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН роХрогрпНроЯро▒ро┐ропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ:</strong><br>
                тАв рокроЩрпНроХрпБ рокрпЖропро░рпН: ${mapping.symbol || '<span class="text-danger">роХро╛рогро╡ро┐ро▓рпНро▓рпИ</span>'}<br>
                тАв ро╡ро┐ро▓рпИ: ${mapping.price || '<span class="text-danger">роХро╛рогро╡ро┐ро▓рпНро▓рпИ</span>'}<br>
                тАв Series: ${mapping.series || '<span class="text-danger">роХро╛рогро╡ро┐ро▓рпНро▓рпИ</span> (EQ ро╡роЯро┐роХроЯрпНроЯро▓рпН ро╡рпЗрогрпНроЯрпБроорпН)'}<br>
                <button class="btn btn-sm btn-warning mt-2" onclick="checkColumns()">роорпАрогрпНроЯрпБроорпН роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН</button>
            `;
            infoDiv.style.display = 'block';
        }
    }
    
    // рооро╛ро▒рпНро▒роорпН родрпКроХрпИ роХрогроХрпНроХрпАроЯрпБ рокро▒рпНро▒ро┐роп родроХро╡ро▓рпИ роХро╛рогрпНрокро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function showChangeCalculationInfo() {
        alert(`рооро╛ро▒рпНро▒роорпН родрпКроХрпИ роХрогроХрпНроХрпАроЯрпБ:\n\n` +
              `1. CSV роХрпЛрокрпНрокро┐ро▓рпН "change" роирпЖроЯрпБро╡ро░ро┐роЪрпИ роЗро▓рпНро▓ро╛ро╡ро┐роЯрпНроЯро╛ро▓рпН:\n` +
              `   рооро╛ро▒рпНро▒роорпН родрпКроХрпИ = (родро▒рпНрокрпЛродрпИроп ро╡ро┐ро▓рпИ ├Ч рооро╛ро▒рпНро▒роорпН роЪродро╡рпАродроорпН) ├╖ 100\n\n` +
              `2. BUY роЯро╛ро░рпНроХрпЖроЯрпН/ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН:\n` +
              `   роЯро╛ро░рпНроХрпЖроЯрпН = ро╡ро┐ро▓рпИ + (рооро╛ро▒рпНро▒роорпН ├Ч 1.5)\n` +
              `   ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН = ро╡ро┐ро▓рпИ - (рооро╛ро▒рпНро▒роорпН ├Ч 1.0)\n\n` +
              `3. SELL роЯро╛ро░рпНроХрпЖроЯрпН/ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН:\n` +
              `   роЯро╛ро░рпНроХрпЖроЯрпН = ро╡ро┐ро▓рпИ - (рооро╛ро▒рпНро▒роорпН ├Ч 1.0)\n` +
              `   ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН = ро╡ро┐ро▓рпИ + (рооро╛ро▒рпНро▒роорпН ├Ч 1.5)\n\n` +
              `роХрпБро▒ро┐рокрпНрокрпБ: BUY рооро▒рпНро▒рпБроорпН SELL роЗро░рогрпНроЯрпБроХрпНроХрпБроорпН роЯро╛ро░рпНроХрпЖроЯрпН/ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН роХрогроХрпНроХро┐роЯрокрпНрокроЯрпБроорпН.`);
    }
    
    // CSV родро░ро╡рпИ роЪро░ро┐рокро╛ро░рпНроХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function checkColumns() {
        const master = storage["StocksTraded"];
        if (!master || master.length === 0) {
            alert("роорпБродро▓ро┐ро▓рпН StocksTraded CSV роХрпЛрокрпНрокрпИ рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН.");
            return;
        }
        
        autoDetectColumns(master[0], "StocksTraded");
        showColumnInfo();
        showDataPreview(master);
        showEQFilterInfo(master);
        
        const columns = Object.keys(master[0]);
        const columnsDiv = document.getElementById('columnInfo');
        columnsDiv.innerHTML += `
            <div class="mt-3">
                <strong>CSV роХрпЛрокрпНрокро┐ро▓рпН роЙро│рпНро│ роЕройрпИродрпНродрпБ роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН:</strong><br>
                <div style="max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    ${columns.map(col => `<code>${col}</code>`).join(', ')}
                </div>
                <p class="mt-2 mb-0"><strong>роорпКродрпНрод ро╡ро░ро┐роЪрпИроХро│рпН:</strong> ${master.length}</p>
            </div>
        `;
    }
    
    // роОрогрпН роородро┐рокрпНрокрпИ рокро╛роХрпБрокроЯрпБродрпНродрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function parseNumber(value) {
        if (value === null || value === undefined || value === "") return 0;
        
        const str = String(value).trim();
        const cleanStr = str.replace('%', '').replace(/,/g, '');
        const num = parseFloat(cleanStr);
        return isNaN(num) ? 0 : num;
    }
    
    // рооро╛ро▒рпНро▒роорпН родрпКроХрпИ роХрогроХрпНроХро┐роЯрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function calculateChange(ltp, pct) {
        // рооро╛ро▒рпНро▒роорпН родрпКроХрпИ = (LTP ├Ч %CHNG) ├╖ 100
        return (ltp * pct) / 100;
    }
    
    // роЯро╛ро░рпНроХрпЖроЯрпН ро╡ро┐ро▓рпИ роХрогроХрпНроХро┐роЯрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ (BUY рооро▒рпНро▒рпБроорпН SELL роЗро░рогрпНроЯрпБроХрпНроХрпБроорпН)
    function calculateTarget(ltp, change, signal) {
        if (signal === "BUY") {
            // BUY: роЯро╛ро░рпНроХрпЖроЯрпН = ро╡ро┐ро▓рпИ + (рооро╛ро▒рпНро▒роорпН ├Ч 1.5)
            return ltp + (Math.abs(change) * 1.5);
        } else if (signal === "SELL") {
            // SELL: роЯро╛ро░рпНроХрпЖроЯрпН = ро╡ро┐ро▓рпИ - (рооро╛ро▒рпНро▒роорпН ├Ч 1.0)
            // SELL роЗро▓рпН change роОродро┐ро░рпНрооро▒рпИропро╛роХ роЗро░рпБроХрпНроХрпБроорпН, роОройро╡рпЗ роорпБро┤рпБроорпИропро╛рой роородро┐рокрпНрокрпИ роОроЯрпБродрпНродрпБроХрпНроХрпКро│рпНроХро┐ро▒рпЛроорпН
            return ltp - (Math.abs(change) * 1.0);
        }
        return 0;
    }
    
    // ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН роХрогроХрпНроХро┐роЯрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ (BUY рооро▒рпНро▒рпБроорпН SELL роЗро░рогрпНроЯрпБроХрпНроХрпБроорпН)
    function calculateStopLoss(ltp, change, signal) {
        if (signal === "BUY") {
            // BUY: ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН = ро╡ро┐ро▓рпИ - (рооро╛ро▒рпНро▒роорпН ├Ч 1.0)
            return ltp - (Math.abs(change) * 1.0);
        } else if (signal === "SELL") {
            // SELL: ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН = ро╡ро┐ро▓рпИ + (рооро╛ро▒рпНро▒роорпН ├Ч 1.5)
            // SELL роЗро▓рпН change роОродро┐ро░рпНрооро▒рпИропро╛роХ роЗро░рпБроХрпНроХрпБроорпН, роОройро╡рпЗ роорпБро┤рпБроорпИропро╛рой роородро┐рокрпНрокрпИ роОроЯрпБродрпНродрпБроХрпНроХрпКро│рпНроХро┐ро▒рпЛроорпН
            return ltp + (Math.abs(change) * 1.5);
        }
        return 0;
    }
    
    // роХро╛ро░рогроЩрпНроХро│рпИ роОрогрпНрогрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function countReasons(reasonText) {
        if (!reasonText || reasonText === "роЪроирпНродрпИ роироЯрпБроиро┐ро▓рпИропро╛роХ роЙро│рпНро│родрпБ" || 
            reasonText === "рооро┐роХроХрпН роХрпБро▒рпИроирпНрод рооро╛ро▒рпНро▒роорпН" || 
            reasonText === "ро╡ро░рпНродрпНродроХроорпН роЪрпЖропрпНропрокрпНрокроЯрпНроЯ рокроЩрпНроХрпБ") {
            return 0;
        }
        
        return reasonText.split(',').length;
    }
    
    // роЕройрпИродрпНродрпБ роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрпБроорпН/роирпАроХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function toggleSelectAllTopStocks() {
        const selectAllCheckbox = document.getElementById('selectAllTopStocks');
        const checkboxes = document.querySelectorAll('.top-stock-checkbox');
        
        if (selectAllCheckbox.checked) {
            // роЕройрпИродрпНродрпИропрпБроорпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН
            selectedTopStocks.clear();
            highlightedStocks.forEach((stock, index) => {
                selectedTopStocks.add(index);
            });
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        } else {
            // роЕройрпИродрпНродрпИропрпБроорпН роирпАроХрпНроХро╡рпБроорпН
            selectedTopStocks.clear();
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        updateSelectedCount();
    }
    
    // роТро░рпБ роорпБроХрпНроХро┐роп рокроЩрпНроХрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function toggleTopStockSelection(index) {
        if (selectedTopStocks.has(index)) {
            selectedTopStocks.delete(index);
        } else {
            selectedTopStocks.add(index);
        }
        
        // "роЕройрпИродрпНродрпБроорпН родрпЗро░рпНроирпНродрпЖроЯрпБ" роЪрпЖроХрпНтАМрокро╛роХрпНро╕рпИ рокрпБродрпБрокрпНрокро┐роХрпНроХро╡рпБроорпН
        const selectAllCheckbox = document.getElementById('selectAllTopStocks');
        const checkboxes = document.querySelectorAll('.top-stock-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
        
        updateSelectedCount();
    }
    
    // родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ роОрогрпНрогро┐роХрпНроХрпИропрпИ рокрпБродрпБрокрпНрокро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function updateSelectedCount() {
        const badge = document.getElementById('selectedCountBadge');
        if (selectedTopStocks.size > 0) {
            badge.textContent = `${selectedTopStocks.size} родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯродрпБ`;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпИ роХро╛роЯрпНроЯрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function showHighlightedStocks() {
        if (highlightedStocks.length === 0) {
            alert("1 роХрпНроХрпБ роорпЗро▒рпНрокроЯрпНроЯ роХро╛ро░рогроЩрпНроХро│рпН роЙро│рпНро│ рокроЩрпНроХрпБроХро│рпН роЗро▓рпНро▓рпИ.");
            return;
        }
        
        const topStocksSection = document.getElementById('topStocksSection');
        const topStocksList = document.getElementById('topStocksList');
        
        let html = '';
        highlightedStocks.forEach((stock, index) => {
            const targetBadgeClass = stock.signal === "BUY" ? "target-badge" : "sell-target-badge";
            const stopLossBadgeClass = stock.signal === "BUY" ? "stop-loss-badge" : "sell-stop-loss-badge";
            const isSelected = selectedTopStocks.has(index);
            
            html += `
                <div class="top-stock-item">
                    <div style="flex: 0.5;">
                        <input class="form-check-input top-stock-checkbox" type="checkbox" 
                               id="topStockCheckbox${index}" 
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleTopStockSelection(${index})">
                    </div>
                    <div style="flex: 1.5;">
                        <strong>${index + 1}. ${stock.symbol}</strong>
                        <div class="small">ро╡ро┐ро▓рпИ: тВ╣${stock.ltp} | рооро╛ро▒рпНро▒роорпН: тВ╣${stock.change} (${stock.pct}%)</div>
                        <div class="small text-muted">${stock.reason}</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div class="${targetBadgeClass} mb-1">роЯро╛ро░рпНроХрпЖроЯрпН: тВ╣${stock.target}</div>
                        <div class="${stopLossBadgeClass}">ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН: тВ╣${stock.stopLoss}</div>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <span class="reason-count-badge mb-1">${stock.reasonCount} роХро╛ро░рогроЩрпНроХро│рпН</span>
                        <span class="badge-custom" style="background-color:${stock.color}">${stock.signal}</span>
                    </div>
                </div>
            `;
        });
        
        topStocksList.innerHTML = html;
        topStocksSection.style.display = 'block';
        
        // родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ роОрогрпНрогро┐роХрпНроХрпИропрпИ рокрпБродрпБрокрпНрокро┐роХрпНроХро╡рпБроорпН
        updateSelectedCount();
        
        topStocksSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    // родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпИ рокро┐ро░ро┐рогрпНроЯрпН роЪрпЖропрпНропрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function printSelectedStocks() {
        if (selectedTopStocks.size === 0) {
            alert("роорпБродро▓ро┐ро▓рпН роЪро┐ро▓ рокроЩрпНроХрпБроХро│рпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН.");
            return;
        }
        
        // родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ рокроЩрпНроХрпБроХро│рпИ ро╡ро░ро┐роЪрпИропро╛роХ роЕроЯрпБроХрпНроХро╡рпБроорпН
        const selectedIndices = Array.from(selectedTopStocks).sort((a, b) => a - b);
        const selectedStocks = selectedIndices.map(index => highlightedStocks[index]);
        
        preparePrintData(selectedStocks, "родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХрокрпНрокроЯрпНроЯ роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН");
    }
    
    // родро▒рпНрокрпЛродрпИроп рокроХрпНроХродрпНродрпИ рокро┐ро░ро┐рогрпНроЯрпН роЪрпЖропрпНропрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function printCurrentPage() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, finalArray.length);
        const currentData = finalArray.slice(startIndex, endIndex);
        
        preparePrintData(currentData, `рокроХрпНроХроорпН ${currentPage} - рокроЩрпНроХрпБроХро│рпН`);
    }
    
    // рокро┐ро░ро┐рогрпНроЯрпН родро░ро╡рпИ родропро╛ро░рпНрокроЯрпБродрпНродрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function preparePrintData(stocks, title) {
        if (stocks.length === 0) {
            alert("рокро┐ро░ро┐рогрпНроЯрпН роЪрпЖропрпНроп рокроЩрпНроХрпБроХро│рпН роЗро▓рпНро▓рпИ.");
            return;
        }
        
        // родрпЗродро┐ рооро▒рпНро▒рпБроорпН рокрпБро│рпНро│ро┐ро╡ро┐ро╡ро░роЩрпНроХро│рпИ роЕроорпИроХрпНроХро╡рпБроорпН
        const printDate = new Date().toLocaleDateString('ta-IN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        
        document.getElementById('print-date').textContent = printDate;
        document.getElementById('print-total').textContent = stocks.length;
        
        // BUY, SELL, HOLD роОрогрпНрогро┐роХрпНроХрпИ роХрогроХрпНроХро┐роЯро╡рпБроорпН
        let buyCount = 0, sellCount = 0, holdCount = 0;
        stocks.forEach(stock => {
            if (stock.signal === "BUY") buyCount++;
            else if (stock.signal === "SELL") sellCount++;
            else holdCount++;
        });
        
        document.getElementById('print-buy').textContent = buyCount;
        document.getElementById('print-sell').textContent = sellCount;
        document.getElementById('print-hold').textContent = holdCount;
        
        // рокро┐ро░ро┐рогрпНроЯрпН роЙроЯро▓рпИ роиро┐ро░рокрпНрокро╡рпБроорпН
        let printHtml = '';
        
        stocks.forEach((item, i) => {
            const targetBadgeClass = item.signal === "BUY" ? "target-badge" : "sell-target-badge";
            const stopLossBadgeClass = item.signal === "BUY" ? "stop-loss-badge" : "sell-stop-loss-badge";
            
            printHtml += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${i + 1}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>${item.symbol}</strong></td>
                    <td style="border: 1px solid #ddd; padding: 8px;">тВ╣${item.ltp}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; ${parseFloat(item.pct) >= 0 ? 'color: var(--success-color);' : 'color: var(--danger-color);'}">
                        ${parseFloat(item.pct) >= 0 ? '+' : ''}${item.pct}%
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${item.series}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        <span style="background-color:${item.color}; color:white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">
                            ${item.signal}
                        </span>
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px; font-size: 12px;">${item.reason}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        ${(item.signal === "BUY" || item.signal === "SELL") && parseFloat(item.rawTarget) > 0 ? 
                            `<span style="background-color:${item.signal === "BUY" ? 'var(--target-color)' : 'var(--sell-target-color)'}; color:white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">
                                тВ╣${item.target}
                            </span>` : 
                            '<span style="color: #666; font-size: 11px;">-</span>'}
                    </td>
                    <td style="border: 1px solid #ddd; padding: 8px;">
                        ${(item.signal === "BUY" || item.signal === "SELL") && parseFloat(item.rawStopLoss) > 0 ? 
                            `<span style="background-color:${item.signal === "BUY" ? 'var(--stop-loss-color)' : 'var(--sell-stop-loss-color)'}; color:white; padding: 2px 6px; border-radius: 8px; font-size: 11px;">
                                тВ╣${item.stopLoss}
                            </span>` : 
                            '<span style="color: #666; font-size: 11px;">-</span>'}
                    </td>
                </tr>
            `;
        });
        
        document.getElementById('print-body').innerHTML = printHtml;
        
        // родро▓рпИрокрпНрокрпИ роЕроорпИроХрпНроХро╡рпБроорпН
        const printableArea = document.getElementById('printable-area');
        const titleElement = printableArea.querySelector('h2');
        titleElement.textContent = `ЁЯУК ${title} - ${printDate}`;
        
        // рокро┐ро░ро┐рогрпНроЯрпН роЪрпЖропрпНропро╡рпБроорпН
        printReport();
    }
    
    // рокро┐ро░ро┐рогрпНроЯрпН роЪрпЖропрпНропрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function printReport() {
        const printableArea = document.getElementById('printable-area');
        
        // рокро┐ро░ро┐рогрпНроЯрпН рокроХрпБродро┐ропрпИ роХро╛рогрпНрокро┐роХрпНроХро╡рпБроорпН
        printableArea.style.display = 'block';
        
        // рокро┐ро░ро┐рогрпНроЯрпН роЯропро▓ро╛роХрпН родро┐ро▒роХрпНроХро╡рпБроорпН
        window.print();
        
        // рокро┐ро░ро┐рогрпНроЯрпН роорпБроЯро┐роирпНрод рокро┐ро▒роХрпБ рооро▒рпИроХрпНроХро╡рпБроорпН
        setTimeout(() => {
            printableArea.style.display = 'none';
        }, 100);
    }
    
    // роЕройрпИродрпНродрпБ рокроЩрпНроХрпБроХро│рпИропрпБроорпН роХро╛роЯрпНроЯрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function showAllStocks() {
        document.getElementById('topStocksSection').style.display = 'none';
        document.getElementById('reasonFilter').value = 'ALL';
        filter();
    }
    
    // роЕройрпИродрпНродрпБ роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпИ WhatsApp роЗро▓рпН рокроХро┐ро░рпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function shareAllTopStocks() {
        if (highlightedStocks.length === 0) {
            alert("роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН роЗро▓рпНро▓рпИ.");
            return;
        }
        
        let message = "ЁЯУИ *роорпБроХрпНроХро┐роп рокроЩрпНроХрпБ рокро░ро┐роирпНродрпБро░рпИроХро│рпН* ЁЯУИ\n\n";
        message += `родрпЗродро┐: ${new Date().toLocaleDateString('ta-IN')}\n`;
        message += `роорпКродрпНрод роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│рпН: ${highlightedStocks.length}\n\n`;
        
        highlightedStocks.forEach((stock, index) => {
            message += `*${index + 1}. ${stock.symbol}*\n`;
            message += `ро╡ро┐ро▓рпИ: тВ╣${stock.ltp}\n`;
            message += `рооро╛ро▒рпНро▒роорпН: тВ╣${stock.change} (${stock.pct}%)\n`;
            message += `роЪро┐роХрпНройро▓рпН: ${stock.signal}\n`;
            
            if (stock.signal === "BUY") {
                message += `ЁЯОп роЯро╛ро░рпНроХрпЖроЯрпН: тВ╣${stock.target}\n`;
                message += `ЁЯЫС ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН: тВ╣${stock.stopLoss}\n`;
            } else if (stock.signal === "SELL") {
                message += `ЁЯФ╗ роЯро╛ро░рпНроХрпЖроЯрпН: тВ╣${stock.target}\n`;
                message += `ЁЯФ╝ ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН: тВ╣${stock.stopLoss}\n`;
            }
            
            message += `роХро╛ро░рогроорпН: ${stock.reason}\n`;
            message += `---\n`;
        });
        
        message += `\nЁЯТб *родроХро╡ро▓рпН:*\n`;
        message += `тАв EQ рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН\n`;
        message += `тАв 1 роХрпНроХрпБ роорпЗро▓рпН роХро╛ро░рогроЩрпНроХро│рпН роЙро│рпНро│ рокроЩрпНроХрпБроХро│рпН\n`;
        message += `тАв BUY & SELL роЗро░рогрпНроЯрпБроХрпНроХрпБроорпН роЯро╛ро░рпНроХрпЖроЯрпН/ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН\n\n`;
        message += `#рокроЩрпНроХрпБроЪрпНроЪроирпНродрпИ #рокро░ро┐роирпНродрпБро░рпИроХро│рпН`;
        
        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }
    
    // роорпБроХрпНроХро┐роп рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЪрпЖропро▓рпНрокро╛роЯрпБ
    function analyzeEverything() {
        const master = storage["StocksTraded"];
        if (!master || master.length === 0) {
            alert("родропро╡рпБ роЪрпЖропрпНродрпБ StocksTraded CSV роХрпЛрокрпНрокрпИ рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН.");
            return;
        }
        
        const mapping = columnMapping["StocksTraded"];
        if (!mapping.symbol || !mapping.price || !mapping.series) {
            alert("CSV роХрпЛрокрпНрокро┐ро▓рпН рокроЩрпНроХрпБ рокрпЖропро░рпН, ро╡ро┐ро▓рпИ рооро▒рпНро▒рпБроорпН Series роирпЖроЯрпБро╡ро░ро┐роЪрпИроХро│рпН роХрогрпНроЯро▒ро┐ропрокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ.");
            return;
        }
        
        const btn = document.getElementById('analyzeBtn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роироЯрпИрокрпЖро▒рпБроХро┐ро▒родрпБ...';
        btn.disabled = true;
        
        setTimeout(() => {
            let totalRows = master.length;
            let eqRows = 0;
            let nonEqRows = 0;
            
            highlightedStocks = [];
            selectedTopStocks.clear();
            
            finalArray = master.map((row, index) => {
                const symbol = row[mapping.symbol];
                if (!symbol || symbol.trim() === '') return null;
                
                const seriesValue = row[mapping.series] ? String(row[mapping.series]).trim().toUpperCase() : '';
                if (seriesValue !== 'EQ') {
                    nonEqRows++;
                    return null;
                }
                
                eqRows++;
                
                // ро╡ро┐ро▓рпИ
                const ltp = parseNumber(row[mapping.price]);
                
                // рооро╛ро▒рпНро▒роорпН роЪродро╡рпАродроорпН
                let pct = 0;
                if (mapping.changePct) {
                    pct = parseNumber(row[mapping.changePct]);
                }
                
                // рооро╛ро▒рпНро▒роорпН родрпКроХрпИ
                let change = 0;
                if (mapping.change && row[mapping.change]) {
                    change = parseNumber(row[mapping.change]);
                } else {
                    // роХрогроХрпНроХро┐роЯрпБ: рооро╛ро▒рпНро▒роорпН родрпКроХрпИ = (LTP ├Ч %CHNG) ├╖ 100
                    change = calculateChange(ltp, pct);
                }
                
                // рооро▒рпНро▒ роХрпЛрокрпНрокрпБроХро│ро┐ро▓рпН роЗроирпНрод рокроЩрпНроХрпБ роЙро│рпНро│родро╛ роОрой роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН
                const is52H = storage["52WeekHigh"]?.some(d => 
                    getValue(d, ['symbol', 'ticker']) === symbol
                );
                const is52L = storage["52WeekLow"]?.some(d => 
                    getValue(d, ['symbol', 'ticker']) === symbol
                );
                const isUpper = storage["Upper Band"]?.some(d => 
                    getValue(d, ['symbol', 'ticker']) === symbol
                );
                const isLower = storage["Lower Band"]?.some(d => 
                    getValue(d, ['symbol', 'ticker']) === symbol
                );
                const isT20G = storage["T20-gainers"]?.some(d => 
                    getValue(d, ['symbol', 'ticker']) === symbol
                );
                const isT20L = storage["T20-loosers"]?.some(d => 
                    getValue(d, ['symbol', 'ticker']) === symbol
                );
                
                // рокро░ро┐роирпНродрпБро░рпИ рооро▒рпНро▒рпБроорпН роХро╛ро░рогроорпН родрпАро░рпНрооро╛ройро┐роХрпНроХро╡рпБроорпН
                let signal = "HOLD";
                let reason = "роЪроирпНродрпИ роироЯрпБроиро┐ро▓рпИропро╛роХ роЙро│рпНро│родрпБ";
                let color = "#f59e0b";
                let reasonDetails = [];
                let reasonCount = 0;
                
                // роХро╛ро░рогроЩрпНроХро│рпИ роЪрпЗроХро░ро┐роХрпНроХро╡рпБроорпН
                if (is52H) reasonDetails.push("52 ро╡ро╛ро░ роЙропро░рпНро╡рпБ");
                if (isUpper) reasonDetails.push("роорпЗро▓рпН рокроЯрпНроЯрпИ");
                if (isT20G) reasonDetails.push("роЗройрпНро▒рпИроп роорпБродро▓рпН 20 ро▓ро╛рок рокроЩрпНроХрпБроХро│рпН");
                if (pct > 2.0) reasonDetails.push(`${pct.toFixed(2)}% роЙропро░рпНро╡рпБ`);
                
                if (is52L) reasonDetails.push("52 ро╡ро╛ро░ родро╛ро┤рпНро╡рпБ");
                if (isLower) reasonDetails.push("роХрпАро┤рпН рокроЯрпНроЯрпИ");
                if (isT20L) reasonDetails.push("роЗройрпНро▒рпИроп роорпБродро▓рпН 20 роиро╖рпНроЯ рокроЩрпНроХрпБроХро│рпН");
                if (pct < -2.0) reasonDetails.push(`${pct.toFixed(2)}% роЪро░ро┐ро╡рпБ`);
                
                reasonCount = reasonDetails.length;
                
                // роЪро┐роХрпНройро▓рпН родрпАро░рпНрооро╛ройроорпН
                const buyScore = (is52H ? 2 : 0) + (isUpper ? 1 : 0) + (isT20G ? 3 : 0) + (pct > 2.0 ? 1 : 0);
                const sellScore = (is52L ? 2 : 0) + (isLower ? 1 : 0) + (isT20L ? 3 : 0) + (pct < -2.0 ? 1 : 0);
                
                if (buyScore >= 3 || (buyScore >= 1 && pct > 3.0)) {
                    signal = "BUY";
                    color = "#10b981";
                    reason = reasonDetails.filter(r => !r.includes("роЪро░ро┐ро╡рпБ") && !r.includes("родро╛ро┤рпНро╡рпБ")).join(", ");
                } else if (sellScore >= 3 || (sellScore >= 1 && pct < -3.0)) {
                    signal = "SELL";
                    color = "#ef4444";
                    reason = reasonDetails.filter(r => !r.includes("роЙропро░рпНро╡рпБ") && !r.includes("роЙропро░рпНро╡рпБ")).join(", ");
                } else {
                    if (reasonCount === 0) {
                        if (Math.abs(pct) < 0.5) reason = "рооро┐роХроХрпН роХрпБро▒рпИроирпНрод рооро╛ро▒рпНро▒роорпН";
                    } else {
                        reason = reasonDetails.join(", ");
                    }
                }
                
                if (!reason || reason.trim() === '') {
                    reason = "роЪроирпНродрпИ роироЯрпБроиро┐ро▓рпИропро╛роХ роЙро│рпНро│родрпБ";
                }
                
                // роЯро╛ро░рпНроХрпЖроЯрпН рооро▒рпНро▒рпБроорпН ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН роХрогроХрпНроХро┐роЯрпБ (BUY рооро▒рпНро▒рпБроорпН SELL роЗро░рогрпНроЯрпБроХрпНроХрпБроорпН)
                const target = calculateTarget(ltp, change, signal);
                const stopLoss = calculateStopLoss(ltp, change, signal);
                
                const stockData = {
                    index: index + 1,
                    symbol: symbol.trim(),
                    ltp: ltp.toFixed(2),
                    change: change.toFixed(2),
                    pct: pct.toFixed(2),
                    series: seriesValue,
                    signal,
                    reason,
                    color,
                    target: target > 0 ? target.toFixed(2) : "0.00",
                    stopLoss: stopLoss > 0 ? stopLoss.toFixed(2) : "0.00",
                    rawPct: pct,
                    rawChange: change,
                    rawTarget: target,
                    rawStopLoss: stopLoss,
                    reasonCount: countReasons(reason),
                    is52H, is52L, isUpper, isLower, isT20G, isT20L
                };
                
                // 1 роХрпНроХрпБ роорпЗро▓рпН роХро╛ро░рогроЩрпНроХро│рпН роЗро░рпБроирпНродро╛ро▓рпН роорпБроХрпНроХро┐роп рокроЩрпНроХрпБроХро│ро┐ро▓рпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН
                if (stockData.reasonCount > 1) {
                    highlightedStocks.push(stockData);
                }
                
                return stockData;
            }).filter(x => x !== null);
            
            document.getElementById('totalRows').textContent = totalRows;
            document.getElementById('eqRows').textContent = eqRows;
            document.getElementById('highlightedRows').textContent = highlightedStocks.length;
            
            highlightedStocks.sort((a, b) => b.reasonCount - a.reasonCount);
            
            originalOrder = [...finalArray];
            
            document.getElementById('dashboard').style.display = 'block';
            
            if (highlightedStocks.length > 0) {
                showHighlightedStocks();
            }
            
            render();
            
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> рокроХрпБрокрпНрокро╛ропрпНро╡рпИ роорпАрогрпНроЯрпБроорпН роЪрпЖропрпНроХ';
            btn.disabled = false;
            
            // родро░ро╡рпИ родро╛ройро╛роХ роЪрпЗрооро┐роХрпНроХро╡рпБроорпН
            saveToLocalStorage();
            
            document.getElementById('dashboard').scrollIntoView({ behavior: 'smooth' });
            
        }, 1000);
    }
    
    // роорпБроЯро┐ро╡рпБроХро│рпИ роХро╛роЯрпНроЯрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function render(data = finalArray) {
        const resDiv = document.getElementById('results');
        const noResultsDiv = document.getElementById('noResults');
        const paginationDiv = document.getElementById('pagination');
        
        if (data.length === 0) {
            resDiv.innerHTML = '';
            noResultsDiv.style.display = 'block';
            paginationDiv.innerHTML = '';
            updateStats(0, 0, 0);
            return;
        }
        
        noResultsDiv.style.display = 'none';
        
        const reasonFilter = document.getElementById('reasonFilter').value;
        
        let filteredData = data;
        if (reasonFilter === 'MULTIPLE') {
            filteredData = data.filter(d => d.reasonCount > 1);
        } else if (reasonFilter === 'HIGHLIGHT') {
            filteredData = highlightedStocks;
        }
        
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
        const currentData = filteredData.slice(startIndex, endIndex);
        
        let b = 0, s = 0, h = 0;
        let html = '';
        
        currentData.forEach((item, i) => {
            if (item.signal === 'BUY') b++;
            else if (item.signal === 'SELL') s++;
            else h++;
            
            const waMsg = `рокроЩрпНроХрпБ: ${item.symbol}%0ASeries: ${item.series}%0Aро╡ро┐ро▓рпИ: тВ╣${item.ltp}%0Aрооро╛ро▒рпНро▒роорпН: тВ╣${item.change} (${item.pct}%)%0AроЪро┐роХрпНройро▓рпН: ${item.signal}%0AроХро╛ро░рогроорпН: ${item.reason}`;
            
            const changeStyle = parseFloat(item.rawChange) !== 0 ? 
                (parseFloat(item.rawChange) >= 0 ? 'positive' : 'negative') : 
                'text-muted';
            
            const reasonClass = item.reasonCount > 1 ? 'reason-highlight' : '';
            
            const stockCardClass = item.reasonCount > 1 ? 'highlight' : '';
            
            // BUY рооро▒рпНро▒рпБроорпН SELL роЗро▒рпНроХрпБ ро╡рпЖро╡рпНро╡рпЗро▒рпБ badge ро╡роХрпИроХро│рпН
            const targetBadgeClass = item.signal === "BUY" ? "target-badge" : "sell-target-badge";
            const stopLossBadgeClass = item.signal === "BUY" ? "stop-loss-badge" : "sell-stop-loss-badge";
            
            html += `
                <tr class="${stockCardClass}">
                    <td>${startIndex + i + 1}</td>
                    <td><strong>${item.symbol}</strong></td>
                    <td class="price-cell">тВ╣${item.ltp}</td>
                    <td class="${changeStyle} price-cell">${parseFloat(item.rawChange) >= 0 ? '+' : ''}${item.change}</td>
                    <td class="percentage-change ${parseFloat(item.pct) >= 0 ? 'positive' : 'negative'} price-cell">${parseFloat(item.pct) >= 0 ? '+' : ''}${item.pct}%</td>
                    <td><span class="series-badge">${item.series}</span></td>
                    <td><span class="badge-custom" style="background-color:${item.color}">${item.signal}</span></td>
                    <td>
                        <div class="${reasonClass}">
                            ${item.reason}
                            ${item.reasonCount > 1 ? 
                                `<span class="reason-count-badge ms-2">${item.reasonCount} роХро╛ро░рогроЩрпНроХро│рпН</span>` : 
                                ''}
                        </div>
                    </td>
                    <td>
                        ${(item.signal === "BUY" || item.signal === "SELL") && parseFloat(item.rawTarget) > 0 ? 
                            `<span class="${targetBadgeClass}">тВ╣${item.target}</span>` : 
                            '<span class="text-muted small">-</span>'}
                    </td>
                    <td>
                        ${(item.signal === "BUY" || item.signal === "SELL") && parseFloat(item.rawStopLoss) > 0 ? 
                            `<span class="${stopLossBadgeClass}">тВ╣${item.stopLoss}</span>` : 
                            '<span class="text-muted small">-</span>'}
                    </td>
                    <td class="no-print"><a href="https://wa.me/?text=${waMsg}" target="_blank" class="whatsapp-icon" title="WhatsApp роЗро▓рпН рокроХро┐ро░рпНроХ"><i class="fab fa-whatsapp"></i></a></td>
                </tr>
            `;
        });
        
        resDiv.innerHTML = html;
        updateStats(filteredData.length, b, s, h);
        
        let paginationHtml = '';
        if (totalPages > 1) {
            paginationHtml = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(1)">роорпБродро▓рпН</a>
                </li>
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">роорпБроирпНродрпИроп</a>
                </li>
            `;
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }
            
            paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">роЕроЯрпБродрпНродрпБ</a>
                </li>
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${totalPages})">роХроЯрпИроЪро┐</a>
                </li>
            `;
        }
        
        paginationDiv.innerHTML = paginationHtml;
    }
    
    // рокроХрпНроХродрпНродрпИ рооро╛ро▒рпНро▒рпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function changePage(page) {
        if (page < 1 || page > Math.ceil(finalArray.length / itemsPerPage)) return;
        currentPage = page;
        render();
        window.scrollTo({ top: document.getElementById('resultsTable').offsetTop - 100, behavior: 'smooth' });
    }
    
    // рокрпБро│рпНро│ро┐ро╡ро┐ро╡ро░роЩрпНроХро│рпИ рокрпБродрпБрокрпНрокро┐роХрпНроХрпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function updateStats(total, buy, sell, hold) {
        document.getElementById('totalS').innerText = total;
        document.getElementById('buyS').innerText = buy;
        document.getElementById('sellS').innerText = sell;
        document.getElementById('holdS').innerText = hold;
    }
    
    // родрпЗроЯро▓рпН рооро▒рпНро▒рпБроорпН ро╡роЯро┐роХроЯрпНроЯро▓рпН
    function filter() {
        const txt = document.getElementById('search').value.toUpperCase();
        const sig = document.getElementById('sigFilter').value;
        const pctFilter = document.getElementById('pctFilter').value;
        const reasonFilter = document.getElementById('reasonFilter').value;
        
        let filtered = originalOrder;
        
        if (reasonFilter === 'MULTIPLE') {
            filtered = originalOrder.filter(d => d.reasonCount > 1);
        } else if (reasonFilter === 'HIGHLIGHT') {
            filtered = highlightedStocks;
        }
        
        filtered = filtered.filter(d => {
            const symbolMatch = d.symbol.toUpperCase().includes(txt);
            const signalMatch = sig === 'ALL' || d.signal === sig;
            
            let pctMatch = true;
            if (pctFilter === 'POSITIVE') pctMatch = d.rawPct > 0;
            else if (pctFilter === 'NEGATIVE') pctMatch = d.rawPct < 0;
            else if (pctFilter === 'HIGH') pctMatch = d.rawPct > 2.0;
            else if (pctFilter === 'LOW') pctMatch = d.rawPct < -2.0;
            
            return symbolMatch && signalMatch && pctMatch;
        });
        
        const sortType = document.getElementById('sortFilter').value;
        switch(sortType) {
            case 'pct_high':
                filtered.sort((a, b) => b.rawPct - a.rawPct);
                break;
            case 'pct_low':
                filtered.sort((a, b) => a.rawPct - b.rawPct);
                break;
            case 'name':
                filtered.sort((a, b) => a.symbol.localeCompare(b.symbol));
                break;
            case 'reasons':
                filtered.sort((a, b) => b.reasonCount - a.reasonCount);
                break;
            case 'target_high':
                filtered.sort((a, b) => b.rawTarget - a.rawTarget);
                break;
        }
        
        currentPage = 1;
        finalArray = filtered;
        render();
    }
    
    // родро░ро╡рпИ ро╡ро░ро┐роЪрпИрокрпНрокроЯрпБродрпНродрпБродро▓рпН
    function sortData() {
        filter();
    }
    
    // родро░ро╡рпИ роПро▒рпНро▒рпБроХрпНроХрпКро│рпНро│рпБроорпН роЪрпЖропро▓рпНрокро╛роЯрпБ
    function exportData() {
        if (finalArray.length === 0) {
            alert("роорпБродро▓ро┐ро▓рпН рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЪрпЖропрпНропро╡рпБроорпН");
            return;
        }
        
        let csvContent = "роОрогрпН,рокроЩрпНроХрпБ рокрпЖропро░рпН,ро╡ро┐ро▓рпИ (тВ╣),рооро╛ро▒рпНро▒роорпН родрпКроХрпИ,рооро╛ро▒рпНро▒роорпН %,Series,роЪро┐роХрпНройро▓рпН,роХро╛ро░рогроЩрпНроХро│рпН,роХро╛ро░рогроорпН,роЯро╛ро░рпНроХрпЖроЯрпН,ро╕рпНроЯро╛рокрпН ро▓ро╛ро╕рпН\n";
        
        finalArray.forEach(item => {
            csvContent += `${item.index},"${item.symbol}",${item.ltp},${item.change},${item.pct},${item.series},"${item.signal}",${item.reasonCount},"${item.reason}",${item.target},${item.stopLoss}\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", "рокроЩрпНроХрпБ_рокроХрпБрокрпНрокро╛ропрпНро╡рпБ_роорпБроЯро┐ро╡рпБроХро│рпН_EQ_роороЯрпНроЯрпБроорпН.csv");
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // роЗрогрпИрокрпНрокрпБ роиро┐роХро┤рпНро╡рпБ роХрпЗроЯрпНрокро╛ройрпНроХро│рпН
    document.getElementById('search').addEventListener('keyup', filter);
    document.getElementById('sigFilter').addEventListener('change', filter);
    document.getElementById('pctFilter').addEventListener('change', filter);
    document.getElementById('reasonFilter').addEventListener('change', filter);
    document.getElementById('sortFilter').addEventListener('change', sortData);
    
    // рокроХрпНроХродрпНродрпИ роПро▒рпНро▒рпБроорпНрокрпЛродрпБ ро▓рпЛроХрпНроХро▓рпН ро╕рпНроЯрпЛро░рпЗроЬро┐ро▓рпН роЗро░рпБроирпНродрпБ родро░ро╡рпИ роПро▒рпНро▒ роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН
    window.addEventListener('load', function() {
        console.log("рокроЩрпНроХрпБроЪрпН роЪроирпНродрпИ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЕроорпИрокрпНрокрпБ родропро╛ро░ро╛роХ роЙро│рпНро│родрпБ");
        console.log("StocksTraded.csv роорпБроХрпНроХро┐роп роХрпЛрокрпНрокро╛роХ рокропройрпНрокроЯрпБродрпНродрокрпНрокроЯрпБроорпН (EQ рокроЩрпНроХрпБроХро│рпН роороЯрпНроЯрпБроорпН)");
        
        // родро╛ройро╛роХ роорпБроирпНродрпИроп родро░ро╡рпИ роПро▒рпНро▒ роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН
        setTimeout(() => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                document.getElementById('uploadStatus').innerHTML = 
                    `<div class="alert alert-info d-inline-block">
                        <i class="fas fa-info-circle"></i> 
                        роорпБройрпНройро░рпН роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯ родро░ро╡рпБ роХро┐роЯрпИроХрпНроХро┐ро▒родрпБ. 
                        <button class="btn btn-sm btn-primary ms-2" onclick="loadFromLocalStorage()">роПро▒рпНро▒рпБ</button>
                    </div>`;
            }
        }, 1000);
    });
</script>
</body>
</html>